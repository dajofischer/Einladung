<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zusagen / Absagen</title>
  <style>
    :root { --bg:#fff7f2; --card:#ffffff; --text:#222; --muted:#666; --accent:#ff4d6d; --ok:#10b981; --no:#ef4444; }
    html,body { height:100%; margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); }
	    .wrap { min-height:100%; display:grid; place-items:center; padding:24px; }
    .card {
	      width:min(680px, 94vw);
      background:var(--card);
      border-radius:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      padding:28px 24px;
    }
	    h1 { margin:0 0 8px; font-size:clamp(24px, 5vw, 38px); }
    p { margin:0 0 14px; line-height:1.6; }
    .btn {
      display:inline-block; border:none; background:var(--accent); color:white;
      font-weight:700; padding:12px 18px; border-radius:12px; text-decoration:none;
      transition:transform .06s ease, box-shadow .2s; box-shadow:0 6px 16px rgba(255,77,109,.3); cursor:pointer;
    }
    .btn:active { transform:translateY(1px); }
    .btn.secondary { background:#eee; color:#222; box-shadow:none; }
    .row { display:grid; gap:16px; grid-template-columns:1fr; }
    .form {
      display:grid; gap:16px; margin:12px 0 22px;
      grid-template-columns:1fr;
    }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-weight:600; }
    input[type="text"] {
      font:inherit; padding:10px 12px; border-radius:10px; border:1px solid #ddd; outline:none;
    }
    .status { display:flex; gap:10px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:8px; border:1px solid #ddd; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none;
    }
    .chip input { accent-color:var(--accent); }
    .emoji-grid {
      display:grid; grid-template-columns:repeat(6, 1fr); gap:10px;
    }
    .emoji {
      font-size:26px; display:grid; place-items:center; border:1px solid #e6e6e6; border-radius:12px; padding:10px; cursor:pointer; background:#fff;
      transition:transform .08s ease, box-shadow .2s, border-color .2s;
    }
    .emoji.selected { border-color:var(--accent); box-shadow:0 6px 16px rgba(255,77,109,.15); transform:translateY(-1px); }
    .avatar-row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .preview {
      width:72px; height:72px; border-radius:16px; border:1px solid #e6e6e6; display:grid; place-items:center; overflow:hidden; background:#fafafa;
    }
    .preview img { width:100%; height:100%; object-fit:cover; display:block; }
    .wall {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:14px;
    }
    .tile {
      border:1px solid #eee; border-radius:16px; background:#fff; padding:12px; display:grid; gap:10px; grid-auto-rows:min-content;
      box-shadow:0 4px 12px rgba(0,0,0,.05);
    }
    .who { font-weight:700; }
    .stat.ok { color:var(--ok); font-weight:700; }
    .stat.no { color:var(--no); font-weight:700; }
    .avatar {
      width:100%; aspect-ratio:1/1; border-radius:12px; background:#fafafa; display:grid; place-items:center; font-size:42px; overflow:hidden;
      border:1px solid #f0f0f0;
    }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }
    .muted { color:var(--muted); font-size:14px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; flex-wrap:wrap; }
    @media (max-width:700px) {
      .emoji-grid { grid-template-columns:repeat(4,1fr); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <h1>Zusagen / Absagen</h1>
        <a class="btn secondary" href="index.html">Zur√ºck</a>
      </div>
      <p>Sag kurz Bescheid, ob du kommst. Such dir einen der 12 Smileys aus oder lade ein Foto hoch. Das erscheint auf der G√§stewand.</p>

      <form class="form" id="rsvpForm">
        <div class="row">
          <div class="field">
            <label for="name">Dein Name</label>
            <input id="name" name="name" type="text" required placeholder="Max Mustermann" />
          </div>

          <div class="field">
            <label>Zusagen oder Absagen</label>
            <div class="status">
              <label class="chip"><input type="radio" name="status" value="yes" required /> Ich komme ‚úÖ</label>
              <label class="chip"><input type="radio" name="status" value="no" /> Ich kann nicht ‚ùå</label>
            </div>
          </div>

          <div class="field">
            <label>Smiley w√§hlen</label>
            <div class="emoji-grid" id="emojiGrid"></div>
          </div>

          <div class="field">
            <label>Oder Foto hochladen</label>
            <div class="avatar-row">
              <input id="photo" type="file" accept="image/*" />
              <div class="preview" id="photoPreview">Kein Bild</div>
            </div>
            <div class="muted">Wenn ein Foto gew√§hlt ist, wird es statt des Smileys gezeigt.</div>
          </div>

          <div class="field" style="display:flex; gap:10px;">
            <button class="btn" type="submit">Eintrag speichern</button>
            <button class="btn secondary" type="button" id="clearMine">Meine Auswahl zur√ºcksetzen</button>
          </div>
        </div>
      </form>

      <h2 style="margin:16px 0 8px; font-size:22px;">G√§stewand</h2>
      <div class="wall" id="wall"></div>
	      <p class="muted" style="margin-top:10px;">Eintr√§ge werden √∂ffentlich auf dem Server gespeichert. Wenn der Server nicht erreichbar ist, werden sie vor√ºbergehend lokal gespeichert.</p>
    </div>
  </div>

  <script>
    const EMOJIS = ["üòÄ","üòé","ü§©","üòÇ","üòú","ü•≥","ü§™","ü§ó","üòá","üò¥","ü§ñ","üê£"];
    const form = document.getElementById('rsvpForm');
    const emojiGrid = document.getElementById('emojiGrid');
    const wall = document.getElementById('wall');
    const photoInput = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');
    const clearMineBtn = document.getElementById('clearMine');
	    const DATA_URL = 'rsvp.php';
	    const EMOJIS_KEY = 'rsvp_list';
	    let selectedEmoji = EMOJIS[0];
	    let photoDataURL = '';
	    function lsRead(){ try { return JSON.parse(localStorage.getItem(EMOJIS_KEY) || '[]') || []; } catch { return []; } }
	    function lsWrite(arr){ try { localStorage.setItem(EMOJIS_KEY, JSON.stringify(arr)); } catch {} return arr; }
	    async function loadAll() {
	      try {
	        const res = await fetch(DATA_URL, { cache:'no-store', headers: { 'Accept': 'application/json' } });
	        if (res.ok) return await res.json();
	      } catch {}
	      return lsRead();
	    }
	    async function saveEntry(entry) {
	      try {
	        const res = await fetch(DATA_URL, {
	          method: 'POST',
	          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
	          body: JSON.stringify(entry)
	        });
	        if (res.ok) return await res.json();
	      } catch {}
	      let list = lsRead();
	      const lname = (entry.name || '').toLowerCase();
	      list = list.filter(x => (x.name || '').toLowerCase() !== lname);
	      list.push(entry);
	      return lsWrite(list);
	    }
	    async function deleteEntry(name) {
	      try {
	        const res = await fetch(DATA_URL, {
	          method: 'DELETE',
	          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
	          body: JSON.stringify({ name })
	        });
	        if (res.ok) return await res.json();
	      } catch {}
	      let list = lsRead();
	      const lname = (name || '').toLowerCase();
	      list = list.filter(x => (x.name || '').toLowerCase() !== lname);
	      return lsWrite(list);
	    }
	    async function loadAll() {
	      try {
	        const res = await fetch(DATA_URL, { cache:'no-store', headers: { 'Accept': 'application/json' } });
	        if (res.ok) return await res.json();
	      } catch {}
	      return lsRead();
	    }
	    async function saveEntry(entry) {
	      let list = await loadAll();
	      const lname = (entry.name || '').toLowerCase();
	      list = list.filter(x => (x.name || '').toLowerCase() !== lname);
	      list.push(entry);
	      try { return await ghSaveList(list); } catch { return lsWrite(list); }
	    }
	    async function deleteEntry(name) {
	      let list = await loadAll();
	      const lname = (name || '').toLowerCase();
	      list = list.filter(x => (x.name || '').toLowerCase() !== lname);
	      try { return await ghSaveList(list); } catch { return lsWrite(list); }
	    }

    function renderEmojiGrid() {
      emojiGrid.innerHTML = '';
      EMOJIS.forEach(emo => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'emoji' + (emo === selectedEmoji ? ' selected' : '');
        b.textContent = emo;
        b.addEventListener('click', () => {
          selectedEmoji = emo;
          Array.from(emojiGrid.children).forEach(el => el.classList.remove('selected'));
          b.classList.add('selected');
        });
        emojiGrid.appendChild(b);
      });
    }

	    async function renderWall() {
	      const list = await loadAll();
	      wall.innerHTML = '';
	      list.forEach(item => {
	        const tile = document.createElement('div');
	        tile.className = 'tile';
	        const avatar = document.createElement('div');
	        avatar.className = 'avatar';
	        if (item.photo) {
	          const img = document.createElement('img');
	          img.src = item.photo;
	          img.alt = '';
	          avatar.appendChild(img);
	        } else {
	          avatar.textContent = item.emoji || "üôÇ";
	        }
	        const who = document.createElement('div');
	        who.className = 'who';
	        who.textContent = item.name || 'Anonym';
	
	        const stat = document.createElement('div');
	        stat.className = 'stat ' + (item.status === 'yes' ? 'ok' : 'no');
	        stat.textContent = item.status === 'yes' ? 'Kommt' : 'Kommt nicht';
	
	        tile.appendChild(avatar);
	        tile.appendChild(who);
	        tile.appendChild(stat);
	        wall.appendChild(tile);
	      });
	    }

    async function fileToDataURL(file, maxSize = 300) {
      if (!file) return '';
      const bitmap = await createImageBitmap(file).catch(() => null);
      if (!bitmap) {
        return new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      }
      const { width, height } = bitmap;
      const scale = Math.min(1, maxSize / Math.max(width, height));
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.round(width * scale));
      canvas.height = Math.max(1, Math.round(height * scale));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }

    photoInput.addEventListener('change', async () => {
      const file = photoInput.files && photoInput.files[0];
      if (!file) {
        photoDataURL = '';
        photoPreview.textContent = 'Kein Bild';
        photoPreview.innerHTML = '';
        photoPreview.textContent = 'Kein Bild';
        return;
      }
      const url = await fileToDataURL(file);
      photoDataURL = url;
      photoPreview.innerHTML = '';
      const img = document.createElement('img');
      img.src = url;
      img.alt = '';
      photoPreview.appendChild(img);
    });

		    form.addEventListener('submit', async (e) => {
		      if (!form.reportValidity()) { e.preventDefault(); return; }
		      e.preventDefault();
		      const data = new FormData(form);
		      const name = (data.get('name') || '').toString().trim();
		      const status = data.get('status');
		      if (!name || !status) { alert('Bitte Name und Status ausw√§hlen.'); return; }
		
		      try {
		        await saveEntry({
		          name,
		          status: status === 'yes' ? 'yes' : 'no',
		          emoji: selectedEmoji,
		          photo: photoDataURL || ''
		        });
		        await renderWall();
		        form.reset();
		        selectedEmoji = EMOJIS[0];
		        photoDataURL = '';
		        renderEmojiGrid();
		        photoPreview.innerHTML = '';
		        photoPreview.textContent = 'Kein Bild';
		        alert('Eintrag gespeichert!');
		      } catch (err) {
		        alert('Konnte nicht speichern. Der Eintrag wird lokal auf diesem Ger√§t gespeichert.');
		      }
		    });

	    clearMineBtn.addEventListener('click', async () => {
	      const name = (document.getElementById('name').value || '').trim();
	      if (!name) { alert('Bitte zuerst deinen Namen eingeben.'); return; }
	      await deleteEntry(name);
	      await renderWall();
	      alert('Dein Eintrag wurde entfernt.');
	    });

    renderEmojiGrid();
    renderWall();
  </script>
</body>
</html>
